<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>è‡ªç«‹å¤§å†’éšª - è‡ªç«‹ç”Ÿæ´»æ¨¡æ“¬å™¨</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 / ReactDOM 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js for Radar Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0b0b0b;
      --paper:#ffffff;
      --bg1:#071022;
      --bg2:#0a1a35;
      --neo:#000;
      --color-591: #ff8000;
      --color-job: #0066cc;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 50% 25%, rgba(45, 110, 230, 0.18), transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .font-pixel{ font-family: "VT323", monospace; letter-spacing: 0.3px; }

    /* Phone Shell */
    .phone-shell{
      width: 390px;
      max-width: 92vw;
      height: 760px;
      max-height: 86vh;
      border-radius: 36px;
      background: linear-gradient(180deg, #111827, #0b1220);
      border: 6px solid #2d2d2d;
      box-shadow: 0 30px 90px rgba(0,0,0,0.55), inset 0 0 0 2px rgba(255,255,255,0.1);
      position: relative;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    
    .side-btn{ position:absolute; left:-8px; width: 6px; border-radius: 4px; background: #2d2d2d; }
    .side-btn.b1{ top:120px; height: 46px; }
    .side-btn.b2{ top:182px; height: 62px; }
    .side-btn.r1{ left:auto; right:-8px; top:170px; height: 86px; }

    .screen{
      flex: 1;
      border-radius: 24px;
      background: #f8fafc;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .scanlines::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: repeating-linear-gradient(to bottom, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 1px, rgba(255,255,255,0) 3px, rgba(255,255,255,0) 6px);
      mix-blend-mode: multiply; opacity: 0.4; z-index: 3;
    }

    /* Neo-Brutalism Styles */
    .neo-shadow{ box-shadow: 4px 4px 0 rgba(0,0,0,1); }
    .neo-card{ background: #fff; border: 2px solid #000; border-radius: 12px; box-shadow: 4px 4px 0 #000; }
    .neo-soft{ background: #fff; border: 2px solid #000; border-radius: 8px; box-shadow: 2px 2px 0 #000; }
    .neo-btn{ border: 2px solid #000; border-radius: 10px; box-shadow: 3px 3px 0 #000; transform: translate(0,0); transition: 0.06s; user-select:none; }
    .neo-btn:active{ transform: translate(2px,2px); box-shadow: 1px 1px 0 #000; }
    .neo-btn[disabled]{ opacity: 0.5; filter: grayscale(1); cursor: not-allowed; box-shadow: none; transform: translate(2px,2px); }

    .float-text{ position:absolute; z-index: 20; font-weight: 800; text-shadow: 2px 2px 0 #000; animation: floatUp 0.9s ease-out both; pointer-events:none; font-family: "VT323", monospace; font-size: 32px; letter-spacing: 0.5px; }
    @keyframes floatUp{ 0%{transform:translateY(0);opacity:0;} 15%{opacity:1;} 100%{transform:translateY(-42px);opacity:0;} }

    /* Wheel Animation */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(1800deg); } }
    .wheel-container { 
      width: 220px; height: 220px; border-radius: 50%; border: 6px solid #000; 
      position: relative; overflow: hidden; 
      background: conic-gradient(#ff8a80 0deg 72deg, #ffd180 72deg 144deg, #ffff8d 144deg 216deg, #cfd8dc 216deg 288deg, #80d8ff 288deg 360deg); 
      box-shadow: 6px 6px 0 #000; 
      margin: 0 auto;
    }
    .wheel-pointer { 
      width: 0; height: 0; 
      border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #000; 
      position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 10; 
    }
    .animate-spin-fast { animation: spin 0.8s cubic-bezier(0.5, 0.1, 0.15, 1) infinite; }

    /* Custom App Styles */
    .style-591-header { background-color: var(--color-591); color: white; }
    .text-591 { color: var(--color-591); }
    .style-job-header { background-color: var(--color-job); color: white; }
    .text-job { color: var(--color-job); }

    .content-scroll::-webkit-scrollbar{ width: 6px; }
    .content-scroll::-webkit-scrollbar-thumb{ background: #ccc; border-radius: 99px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="modal-root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /***********************
     * Utils & Logic (Global)
     ***********************/
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function pickByProbability(items){
      const r = Math.random();
      let acc = 0;
      for(const it of items){ acc += it.prob; if(r <= acc) return it; }
      return items[items.length-1];
    }

    function calcLivingCost(state, house){
      let livingCost = 1500;
      if(state.hasHouse && house && !house.isCCSA) livingCost += 500;
      return livingCost;
    }

    function applyDelta(base, delta){
      const next = {...base};
      if(delta.money) next.money += delta.money;
      if(delta.health) next.health = clamp(next.health + delta.health, 0, 100);
      if(delta.mood) next.mood = clamp(next.mood + delta.mood, 0, 100);
      if(delta.security) next.security = clamp(next.security + delta.security, 0, 100);
      if(delta.ap) next.ap = clamp(next.ap + delta.ap, 0, next.maxAp);
      if(delta.maxAp) next.maxAp = clamp(next.maxAp + delta.maxAp, 1, 9);
      
      if(delta.ccsa){
        const c = {...next.ccsaStats};
        Object.keys(delta.ccsa).forEach(k => {
          c[k] = clamp(c[k] + delta.ccsa[k], 0, 100);
        });
        next.ccsaStats = c;
      }
      return next;
    }

    /***********************
     * Data
     ***********************/
    const INITIAL_STATS = {
      money: 0, health: 100, mood: 55, security: 55, week: 1, maxWeeks: 8, age: 16, ap: 3, maxAp: 3,
      ccsaStats: {
        financial_income: 50, financial_manage: 50, // ç¶“æ¿Ÿ/è²¡å‹™
        living_selfcare: 50, living_housing: 50, living_job: 50, living_learning: 50, // ç”Ÿæ´»/å°±æ¥­
        social_network: 50, social_problem: 50, social_resilience: 50 // ç¤¾æœƒ/å¿ƒç†
      }
    };

    const CHARACTER_ORIGINS = [
      { key:"A", label:"Aï¼šæ¥µåº¦åŒ±ä¹", money:0,    prob:0.10, desc:"èµ·é»å¾ˆç¡¬ï¼Œéœ€å–„ç”¨è³‡æºã€‚" },
      { key:"B", label:"Bï¼šåä½",     money:2000, prob:0.30, desc:"æœ‰ä¸€é»ç·©è¡ï¼Œä»è¦å°å¿ƒã€‚" },
      { key:"C", label:"Cï¼šä¸€èˆ¬",     money:4000, prob:0.30, desc:"ä¸€èˆ¬èµ·é»ï¼Œé æ±ºç­–æ‹‰é–‹å·®è·ã€‚" },
      { key:"D", label:"Dï¼šç•¥é«˜",     money:6000, prob:0.20, desc:"ç¨æœ‰é¤˜è£•ï¼Œä½†åˆ¥äº‚èŠ±ã€‚" },
      { key:"E", label:"Eï¼šç›¸å°ç©©å®š", money:8000, prob:0.10, desc:"èµ·é»è¼ƒå¥½ï¼Œç›®æ¨™æ˜¯å­˜æ›´å¤šã€‚" },
    ];

    const JOBS = [
      { id:"job_flyer", title:"æ´¾å ±/å‚³å–®", wage:190, energy:10, mood:-2, minAge:15, strictAge:false, apCost:1, desc:"èµ°è·¯å¤šã€æºé€šå°‘ã€‚", ccsa:{living_job:5, financial_income:5}, interviews:[] },
      { id:"job_store", title:"è¶…å•†å·¥è®€", wage:185, energy:12, mood:-1, minAge:16, strictAge:false, apCost:1, desc:"çµå¸³è£œè²¨ï¼Œéœ€è€å¿ƒã€‚", ccsa:{living_job:10, social_problem:5}, interviews:[] },
      { id:"job_food", title:"é¤é£²å¤–å ´", wage:190, energy:14, mood:-2, minAge:16, strictAge:false, apCost:1, desc:"èµ°å‹•å¤šã€æœå‹™ç¦®è²Œã€‚", ccsa:{living_job:10, social_network:5}, interviews:[] },
      { id:"job_construction", title:"å·¥åœ°è‡¨æ™‚å·¥", wage:230, energy:18, mood:-3, minAge:18, strictAge:true, apCost:1, desc:"è–ªé«˜è€—é«”åŠ›ï¼Œé‡å·¥å®‰ã€‚", ccsa:{living_job:15, social_resilience:10}, interviews:[] },
      { id:"job_delivery", title:"å¤–é€å“¡", wage:195, energy:15, mood:-1, minAge:18, strictAge:true, apCost:1, desc:"äº¤é€šé¢¨éšªé«˜ã€‚", ccsa:{living_job:10, social_problem:10}, interviews:[] },
      { id:"job_scam", title:"è¼•é¬†è³ºé«˜è–ª", wage:5000, energy:5, mood:-50, minAge:15, strictAge:false, apCost:1, desc:"ã€Œå¹«å¿™è½‰å¸³ã€ï¼Œæ¥µåº¦å¯ç–‘ï¼", ccsa:{social_problem:-20}, interviews:[] },
    ];

    const HOUSING = [
      { id:"house_ccsa", title:"CCSA è‡ªç«‹å®¿èˆ", type:"ccsa", rent:0, deposit:0, security:+15, desc:"é¡å®¶åº­å¼ç®¡ç†ï¼Œéœ€é…åˆå…¬ç´„ã€‚", quizKey:"ccsa_interview", isCCSA:true, ccsa:{living_housing:20, social_network:15} },
      { id:"house_rooftop", title:"é ‚æ¨“åŠ è“‹", type:"rooftop", rent:4500, deposit:9000, security:-10, desc:"å†¬å†·å¤ç†±ã€é•å»ºé¢¨éšªã€‚", quizKey:"house_check", isCCSA:false, ccsa:{living_housing:-5, financial_manage:5} }, 
      { id:"house_basement", title:"åœ°ä¸‹å®¤å¥—æˆ¿", type:"basement", rent:5000, deposit:10000, security:-5, desc:"æ½®æ¿•ä¸é€šé¢¨ã€é€ƒç”Ÿä¸æ˜“ã€‚", quizKey:"house_check", isCCSA:false, ccsa:{living_housing:-5} },
      { id:"house_shared", title:"å®¶åº­å¼åˆç§Ÿ", type:"shared", rent:6000, deposit:12000, security:+5, desc:"å…±ç”¨è¡›æµ´ï¼Œéœ€ç£¨åˆç¿’æ…£ã€‚", quizKey:"rule_check", isCCSA:false, ccsa:{living_housing:10, social_network:10} },
      { id:"house_studio", title:"ç¨ç«‹å¥—æˆ¿", type:"studio", rent:9500, deposit:19000, security:+10, desc:"éš±ç§ä½³ä½†è²´ã€‚", quizKey:"contract_check", isCCSA:false, ccsa:{living_housing:15, financial_manage:-10} },
    ];

    const SHOP_ITEMS = [
      { id:"item_bento", name:"ä¾¿ç•¶", price:120, desc:"èƒ½é‡+3 å¿ƒæƒ…+1", effect:{health:+3,mood:+1}, ageMin:15 },
      { id:"item_b_vitamins", name:"B ç¾¤", price:180, desc:"é«”åŠ› +6", effect:{health:+6}, ageMin:15 },
      { id:"item_milktea", name:"æ‰‹æ–é£²", price:70, desc:"å¿ƒæƒ… +4", effect:{mood:+4}, ageMin:15 },
      { id:"item_clothes", name:"æ–°è¡£", price:800, desc:"å¿ƒæƒ… +10", effect:{mood:+10}, ageMin:15 },
      { id:"item_concert", name:"æ¼”å”±æœƒ", price:1800, desc:"å¿ƒæƒ… +18", effect:{mood:+18}, ageMin:15 },
      { id:"item_phone", name:"iPhone", price:28000, desc:"å¿ƒæƒ… +6 (è²´)", effect:{mood:+6}, ageMin:15, big:true },
      { id:"item_health_ins", name:"å¥ä¿ (é“å…·)", price:500, desc:"é™ä½ç”Ÿç—…æˆæœ¬", itemGrant:"health_insurance", ageMin:15 },
      { id:"item_acc_ins", name:"æ„å¤–éšª (é“å…·)", price:650, desc:"é™ä½æ„å¤–æˆæœ¬", itemGrant:"accident_insurance", ageMin:15 },
      { id:"item_credit", name:"ä¿¡ç”¨å¡ (é“å…·)", price:0, desc:"18+ é–‹å•Ÿä¿¡ç”¨æ”¯ä»˜", itemGrant:"credit_card", ageMin:18, special:"creditCard" },
      { id:"item_scam_stock", name:"é£†è‚¡å…§ç·š", price:5000, desc:"æŠ•è³‡è©é¨™ï¼", scam:true, ageMin:15 },
    ];

    const DORM_QS = [
      { id:"d1", q:"è‡ªç«‹å®¿èˆèˆ‡ä¸€èˆ¬æ—…é¤¨æœ€å¤§çš„å·®åˆ¥ï¼Ÿ", options:["æ²’å·®","å®¿èˆæ˜¯è¨“ç·´å ´åŸŸ"], a:1 },
      { id:"d2", q:"å…¥ä½è‡ªç«‹å®¿èˆï¼Œé€šå¸¸éœ€è¦è² æ“”å“ªäº›è²»ç”¨ï¼Ÿ", options:["å®Œå…¨å…è²»","å…æˆ¿ç§Ÿï¼Œä½†éœ€è‡ªä»˜ä¼™é£Ÿ/æ—¥å¸¸ç”¨å“"], a:1 },
      { id:"d3", q:"èˆ‡å®¤å‹ç™¼ç”Ÿè¡çªï¼Œæœ€å¥½çš„è™•ç†æ–¹å¼ï¼Ÿ", options:["æ‰“æ¶","ä¸»å‹•æºé€šæˆ–æ‰¾ç”Ÿè¼”å“¡"], a:1 },
      { id:"d4", q:"å°æ–¼ã€Œå¤–å®¿ã€çš„è¦å®šï¼Ÿ", options:["éš¨ä¾¿","éœ€æå‰é å‘Šæˆ–è«‹å‡"], a:1 },
      { id:"d5", q:"ç‚ºäº†åŸ¹é¤Šå„²è“„ç¿’æ…£ï¼Œå®¿èˆé€šå¸¸è¦æ±‚ï¼Ÿ", options:["ä¸ç”¨åš","è¨˜å¸³æˆ–å®šé¡å„²è“„"], a:1 },
      { id:"d6", q:"å…¬å…±å€åŸŸæ¸…æ½”æ˜¯èª°çš„è²¬ä»»ï¼Ÿ", options:["ç”Ÿè¼”å“¡","ä½æ°‘å…±åŒåˆ†æ“”"], a:1 },
      { id:"d7", q:"å¯ä»¥éš¨æ„å¸¶æœ‹å‹å›ä¾†éå¤œå—ï¼Ÿ", options:["å¯ä»¥","ä¸è¡Œï¼Œæœ‰é–€ç¦èˆ‡è¨ªå®¢è¦å®š"], a:1 },
      { id:"d8", q:"ç¤¾å·¥åœ¨å®¿èˆçš„è§’è‰²æ˜¯ï¼Ÿ", options:["ä¿æ¯","æŒ‡å°è€…èˆ‡è³‡æºé€£çµè€…"], a:1 },
      { id:"d9", q:"ç¹³ä¸å‡ºè²»ç”¨è©²æ€éº¼è¾¦ï¼Ÿ", options:["é€ƒè·‘","ä¸»å‹•è¨è«–è²¡å‹™è¦åŠƒ"], a:1 },
      { id:"d10", q:"è‡ªç«‹å®¿èˆçš„æœ€çµ‚ç›®æ¨™ï¼Ÿ", options:["æ°¸é ä½é€™","é †åˆ©è½‰éŠœåˆ°ç¤¾æœƒ"], a:1 },
      { id:"d11", q:"å®¿èˆå…§å¯ä»¥æŠ½è¸å–é…’å—ï¼Ÿ", options:["å¯ä»¥","å…¨é¢ç¦æ­¢"], a:1 },
      { id:"d12", q:"æƒ³é¤Šå¯µç‰©å¯ä»¥ç›´æ¥å¸¶é€²å»å—ï¼Ÿ", options:["å¯ä»¥","ä¸è¡Œï¼Œéœ€ç¶“è©•ä¼°"], a:1 },
      { id:"d13", q:"æ™šä¸Šå¹¾é»å¾Œéœ€é™ä½éŸ³é‡ï¼Ÿ", options:["åŠå¤œ3é»","ç´„10-11é»"], a:1 },
      { id:"d14", q:"é›¢é–‹æˆ¿é–“æ™‚æ‡‰è©²ï¼Ÿ", options:["ä¸ç”¨ç®¡","éš¨æ‰‹é—œç‡ˆé—œå†·æ°£"], a:1 },
      { id:"d15", q:"åœ¨å®¿èˆç”Ÿç—…äº†ï¼Ÿ", options:["éš±ç","å‘ŠçŸ¥ç”Ÿè¼”å“¡ä¸¦å°±é†«"], a:1 },
      { id:"d16", q:"å¯ä»¥è¤‡è£½é‘°åŒ™çµ¦æœ‹å‹å—ï¼Ÿ", options:["å¯ä»¥","çµ•å°ä¸è¡Œ"], a:1 },
      { id:"d17", q:"å…±ç”¨å†°ç®±çš„é£Ÿç‰©ï¼Ÿ", options:["éš¨ä¾¿æ”¾","æ¨™ç¤ºåå­—èˆ‡æ—¥æœŸ"], a:1 },
      { id:"d18", q:"æ¬é›¢å®¿èˆé€šå¸¸éœ€å¤šä¹…å‰å‘ŠçŸ¥ï¼Ÿ", options:["ç•¶å¤©","ä¸€å€‹æœˆå‰"], a:1 },
      { id:"d19", q:"åœ¨å®¿èˆæœŸé–“å¿…é ˆå·¥ä½œæˆ–å°±å­¸å—ï¼Ÿ", options:["ä¸ç”¨","æ˜¯çš„ï¼Œéœ€æœ‰ç©©å®šç‹€æ…‹"], a:1 },
      { id:"d20", q:"é‡åˆ°ç«ç½è­¦å ±ï¼Ÿ", options:["æ­é›»æ¢¯","èµ°é€ƒç”Ÿæ¢¯"], a:1 },
    ];

    const HOUSE_QS = [
      { id:"h1", q:"ç‚ºä»€éº¼ä¸å»ºè­°ç§Ÿã€Œé ‚æ¨“åŠ è“‹ã€ï¼Ÿ", options:["è¦–é‡å¤ªå¥½","å†¬å†·å¤ç†±ã€é•å»ºé¢¨éšª"], a:1 },
      { id:"h2", q:"æœªæ»¿18æ­²ç°½ç§Ÿç´„ï¼Ÿ", options:["è‡ªå·±ç°½","éœ€æ³•å®šä»£ç†äººåŒæ„"], a:1 },
      { id:"h3", q:"æŠ¼é‡‘æœ€é«˜ä¸èƒ½è¶…éï¼Ÿ", options:["1å€‹æœˆ","2å€‹æœˆç§Ÿé‡‘"], a:1 },
      { id:"h4", q:"å¦‚ä½•ç¢ºèªéš”éŸ³ï¼Ÿ", options:["çœ‹æ²¹æ¼†","æ•²ç‰†å£ã€çœ‹éš”é–“æè³ª"], a:1 },
      { id:"h5", q:"å¦‚ä½•ç¢ºèªæ½®æ¿•æ¼æ°´ï¼Ÿ", options:["çœ‹å£ç™Œã€æ°´ç—•","çœ‹é¢¨æ°´"], a:0 },
      { id:"h6", q:"é›»è²»ä¸€åº¦8å…ƒåˆç†å—ï¼Ÿ", options:["åˆç†","ä¸åˆç†ï¼Œè¶…éå°é›»ç´šè·"], a:1 },
      { id:"h7", q:"ç¨ç«‹å¥—æˆ¿èˆ‡åˆ†ç§Ÿå¥—æˆ¿å·®åˆ¥ï¼Ÿ", options:["æ²’å·®","ç¨ç«‹é–€ç‰Œé›»è¡¨ vs å…±ç”¨"], a:1 },
      { id:"h8", q:"æƒ³åœ¨ç‰†ä¸Šé‡˜é‡˜å­ï¼Ÿ", options:["ç›´æ¥é‡˜","å…ˆå¾µæ±‚æˆ¿æ±åŒæ„"], a:1 },
      { id:"h9", q:"çœ‹æˆ¿å®‰å…¨èµ·è¦‹ï¼Ÿ", options:["å–®ç¨å‰å¾€","æ‰¾è¦ªå‹é™ªåŒ"], a:1 },
      { id:"h10", q:"æˆ¿æ±è¦ç•™èº«åˆ†è­‰æ­£æœ¬ï¼Ÿ", options:["å¥½","ä¸è¡Œï¼Œåªèƒ½çµ¦å½±æœ¬"], a:1 },
      { id:"h11", q:"æƒ³é¤Šå¯µç‰©ï¼Ÿ", options:["å·é¤Š","äº‹å…ˆè©¢å•ä¸¦è¨»æ˜åˆç´„"], a:1 },
      { id:"h12", q:"ç†±æ°´å™¨è£å“ªè£¡æœ€å±éšªï¼Ÿ", options:["é™½å°","å¯†é–‰å®¤å…§/æµ´å®¤"], a:1 },
      { id:"h13", q:"ç§Ÿç´„æœªåˆ°æœŸæå‰æ¬èµ°ï¼Ÿ", options:["æ²’äº‹","å±¬é•ç´„ï¼Œé€šå¸¸æ‰£æŠ¼é‡‘"], a:1 },
      { id:"h14", q:"æˆ¿æ±èªªä¸ç°½åˆç´„æ¯”è¼ƒçœäº‹ï¼Ÿ", options:["å¥½","ä¸å¥½ï¼Œæ²’ä¿éšœ"], a:1 },
      { id:"h15", q:"å®šé‡‘çš„ä½œç”¨ï¼Ÿ", options:["æ“”ä¿","ä¿ç•™æˆ¿é–“"], a:1 },
      { id:"h16", q:"æˆ¿æ±æ‹’çµ•ä¿®ç¹•è¨­å‚™ï¼Ÿ", options:["å¿è€","å‚¬å‘Šå¾Œè‡ªè¡Œä¿®ç¹•ä¸¦æ‰£æŠµ(ä¾æ°‘æ³•)"], a:1 },
      { id:"h17", q:"åœ°ä¸‹å®¤æ”¹å»ºçš„æˆ¿é–“ï¼Ÿ", options:["ä¾¿å®œå°±å¥½","ä¸å»ºè­°ï¼Œé€šé¢¨é€ƒç”Ÿå·®"], a:1 },
      { id:"h18", q:"æˆ¿æ±å¯ä»¥éš¨æ„é€²ä½ æˆ¿é–“å—ï¼Ÿ", options:["å¯ä»¥","ä¸è¡Œï¼Œæ¶‰å«Œä¾µå…¥ä½å®…"], a:1 },
      { id:"h19", q:"ç…§ç‰‡æ¼‚äº®ä½†åƒ¹æ ¼ä½å¾—é›¢è­œï¼Ÿ", options:["è³ºåˆ°","å¯èƒ½æ˜¯è©é¨™"], a:1 },
      { id:"h20", q:"ç§Ÿå±‹ç³¾ç´›æ‰¾èª°ï¼Ÿ", options:["è­¦å¯Ÿ","å´”åª½åª½/æ¶ˆä¿å®˜/æ³•æ‰¶"], a:1 },
    ];

    const JOB_QS = [
      { id:"j1", q:"è©¦ç”¨æœŸè–ªæ°´æ‰“å…«æŠ˜ï¼Ÿ", options:["åˆç†","ä¸åˆæ³•ï¼Œéœ€é”åŸºæœ¬å·¥è³‡"], a:1 },
      { id:"j2", q:"é¢è©¦è¦æ±‚ç¹³åˆ¶æœè²»/ä¿è­‰é‡‘ï¼Ÿ", options:["ä»˜éŒ¢","æ‹’çµ•ï¼Œå¸¸è¦‹è©é¨™"], a:1 },
      { id:"j3", q:"å·¥è®€ç”Ÿéœ€è¦ä¿å‹å¥ä¿å—ï¼Ÿ", options:["è¦ï¼Œé›‡ä¸»é ˆä¾æ³•æŠ•ä¿","ä¸ç”¨"], a:0 },
      { id:"j4", q:"ç™¼ç”Ÿè·ç½è€é—†ä¸è³ ï¼Ÿ", options:["è‡ªèªå€’æ¥£","é›‡ä¸»æœ‰è£œå„Ÿè²¬ä»»"], a:1 },
      { id:"j5", q:"é¢è©¦è¦æ±‚ä¿ç®¡èº«åˆ†è­‰/å­˜æ‘ºï¼Ÿ", options:["é…åˆ","çµ•å°ä¸è¡Œ"], a:1 },
      { id:"j6", q:"å‹åŸºæ³•æ­£å¸¸å·¥æ™‚ï¼Ÿ", options:["8å°æ™‚","10å°æ™‚"], a:0 },
      { id:"j7", q:"åŠ ç­è²»å‰å…©å°æ™‚æ€éº¼ç®—ï¼Ÿ", options:["å¹³æ—¥å·¥è³‡ x 1.34","ä¸€æ¨£"], a:0 },
      { id:"j8", q:"å·¥ä½œæœªæ»¿3å€‹æœˆé›¢è·é å‘Šï¼Ÿ", options:["ä¸ç”¨é å‘Š(ä½†å»ºè­°äº¤æ¥)","éœ€10å¤©"], a:0 },
      { id:"j9", q:"é‡åˆ°æ€§é¨·æ“¾ï¼Ÿ", options:["å¿è€","è’è­‰ç”³è¨´"], a:1 },
      { id:"j10", q:"å…ç¶“é©—æœˆå…¥åè¬ï¼Ÿ", options:["å¿«å»","è©é¨™/éæ³•å·¥ä½œ"], a:1 },
      { id:"j11", q:"æœªæ»¿16æ­²å·¥æ™‚é™åˆ¶ï¼Ÿ", options:["ç„¡é™åˆ¶","æ¯æ—¥8hr/æ™šä¸Š8é»å¾Œç¦å·¥"], a:1 },
      { id:"j12", q:"è¢«è³‡é£è¦ç´¢å–ä»€éº¼ï¼Ÿ", options:["éè‡ªé¡˜é›¢è·è­‰æ˜","è–ªè³‡å–®"], a:0 },
      { id:"j13", q:"é²åˆ°ä¸€åˆ†é˜æ‰£ä¸€åƒï¼Ÿ", options:["åˆç†","ä¸åˆæ³•ï¼Œæ¯”ä¾‹åŸå‰‡"], a:1 },
      { id:"j14", q:"åœ‹å®šå‡æ—¥ä¸Šç­è–ªæ°´ï¼Ÿ", options:["ä¸€æ¨£","é›™å€è–ªè³‡"], a:1 },
      { id:"j15", q:"åšè·æ¶¯æ¸¬é©—å»å“ªï¼Ÿ", options:["å°±æœç«™/å°ç£å°±æ¥­é€š","ç®—å‘½"], a:0 },
      { id:"j16", q:"é¢è©¦å•éš±ç§(æœ‰ç„¡ç”·å‹)ï¼Ÿ", options:["æ‹’çµ•å›ç­”","å¿…é ˆèª å¯¦"], a:0 },
      { id:"j17", q:"è–ªè³‡å–®é‡‘é¡æœ‰å°‘ï¼Ÿ", options:["ç¢ºèªæ¸…æ¥š","ç®—äº†"], a:0 },
      { id:"j18", q:"å±¥æ­·ç…§ç‰‡ï¼Ÿ", options:["æ­£é¢æ¸…æ™°","ä¿®åœ–è‡ªæ‹"], a:0 },
      { id:"j19", q:"é¢è©¦å¾Œæ²’æ¶ˆæ¯ï¼Ÿ", options:["ç¦®è²Œè©¢å•","ç½µå…¬å¸"], a:0 },
      { id:"j20", q:"å·¥ä½œé¨è»Šç„¡å‹ä¿ï¼Ÿ", options:["è‡ªå·±å°å¿ƒ/éµå®ˆäº¤é€š","æ²’å·®"], a:0 },
    ];

    const GENERIC_JOB_QUESTIONS = [
      { id:"gj_legal_1", q:"è€é—†èªªã€Œè©¦ç”¨æœŸã€è–ªæ°´è¦æ‰“å…«æŠ˜ï¼Œåˆæ³•å—ï¼Ÿ", options:["åˆæ³•ï¼Œæˆ‘æ˜¯æ–°äºº","ä¸åˆæ³•ï¼Œéœ€é”åŸºæœ¬å·¥è³‡"], a:1 },
      { id:"gj_legal_2", q:"é¢è©¦è¦æ±‚ç¹³ã€Œä¿è­‰é‡‘ã€æˆ–ã€Œåˆ¶æœè²»ã€ï¼Ÿ", options:["ä»˜éŒ¢å±•ç¾èª æ„","æ‹’çµ•ï¼Œé€™æ˜¯æ±‚è·è©é¨™ï¼ˆ7ä¸åŸå‰‡ï¼‰"], a:1 },
      { id:"gj_legal_3", q:"å…¬å¸è¦æ±‚ä¿ç®¡ä½ çš„ã€Œèº«åˆ†è­‰ã€æˆ–ã€Œå­˜æ‘ºã€ï¼Ÿ", options:["é…åˆå…¬å¸è¦å®š","çµ•å°ä¸è¡Œï¼Œé¿å…æ·ªç‚ºäººé ­æˆ¶"], a:1 },
      { id:"gj_safe_1", q:"ç™¼ç”Ÿè·æ¥­ç½å®³ï¼ˆå·¥å‚·ï¼‰ï¼Œè€é—†èªªæ˜¯ä½ è‡ªå·±ä¸å°å¿ƒæ‰€ä»¥ä¸è³ ï¼Ÿ", options:["è‡ªèªå€’æ¥£","ä¸å°ï¼Œé›‡ä¸»æœ‰è£œå„Ÿè²¬ä»»"], a:1 },
      { id:"gj_general_1", q:"æ‰“å¡/æ’ç­é‡åˆ°å•é¡Œï¼Œç¬¬ä¸€æ­¥ï¼Ÿ", options:["ç›´æ¥ä¸ä¾†","å‘ä¸»ç®¡ç¢ºèªè¦å‰‡"], a:1 },
    ];

    const SCENARIOS = {
      friend_loan:{ id:"friend_loan", title:"æœ‹å‹å€ŸéŒ¢", body:"æœ‹å‹æ€¥éœ€ç”¨éŒ¢ï¼Œæƒ³è·Ÿä½ å€Ÿã€‚", options:[{ label:"è©•ä¼°èƒ½åŠ›/ç´„å®šé‚„æ¬¾", key:"safe" }, { label:"å…¨éƒ¨å€Ÿä»–", key:"risky" }, { label:"æ‹’çµ•/å»ºè­°æ‰¾è³‡æº", key:"refuse" }] },
      scam_romance:{ id:"scam_romance", title:"æ„Ÿæƒ…è©é¨™", body:"ç¶²å‹å°ä½ å¾ˆå¥½ï¼Œè¦æ±‚åŒ¯æ¬¾æˆ–ä»£æ”¶ã€‚", options:[{ label:"æŸ¥è­‰/æ‹’çµ•é‡‘æµ", key:"safe" }, { label:"ç›¸ä¿¡/åŒ¯æ¬¾", key:"risky" }, { label:"çµ¦å€‹è³‡", key:"very_risky" }] },
      scam_job:{ id:"scam_job", title:"æ±‚è·è©é¨™", body:"ä¿è­‰é«˜è–ªã€å…ˆç¹³éŒ¢æˆ–äº¤è­‰ä»¶ã€‚", options:[{ label:"æ‹’çµ•/æ­£è¦æ±‚è·", key:"safe" }, { label:"ç¹³éŒ¢è©¦è©¦", key:"risky" }, { label:"äº¤å‡ºç¶²éŠ€å¸³å¯†", key:"very_risky" }] },
      accident:{ id:"accident", title:"æ„å¤–äº‹ä»¶", body:"é€šå‹¤ç™¼ç”Ÿæ“¦æ’ï¼Œéœ€è™•ç†é†«ç™‚ã€‚", options:[{ label:"æŒ‰ç¨‹åº/ä¼‘æ¯", key:"handle" }, { label:"ç¡¬æ’", key:"ignore" }] },
      sickness:{ id:"sickness", title:"ç”Ÿç—…äº†", body:"èº«é«”ä¸é©ï¼Œéœ€è¦ä¼‘æ¯ã€‚", options:[{ label:"å°±é†«", key:"rest" }, { label:"ç¡¬æ’", key:"ignore" }] },
      police:{ id:"police", title:"è­¦å¯Ÿè‡¨æª¢", body:"å¤œé–“è‡¨æª¢ï¼Œé…åˆèº«åˆ†æŸ¥é©—ã€‚", options:[{ label:"å†·éœé…åˆ", key:"cooperate" }, { label:"æƒ…ç·’å¤±æ§", key:"panic" }] },
    };
    
    // Quiz Map
    const QUIZ_DB = {
      password_setup: { title:"æ‰‹æ©Ÿå¯†ç¢¼", pickOne:true, questions:[{ id:"pw1", q:"è¨­å®šå¯†ç¢¼ï¼Ÿ", options:["123456","2FA+å¼·å¯†ç¢¼"], a:1 }] },
      
      // Job Center uses JOB_QS
      job_test: { title:"å°±æ¥­æœå‹™ç«™æ¸¬é©—", pickOne:false, questions: JOB_QS },
      
      // Welfare uses mixed
      welfare_life: { title:"ç¤¾ç¦ä¸­å¿ƒï¼šç”Ÿæ´»æ”¯æŒ", pickOne:false, questions: HOUSE_QS.slice(0,10) }, 
      welfare_emergency: { title:"ç¤¾ç¦ä¸­å¿ƒï¼šæ€¥é›£è£œåŠ©", pickOne:false, questions:[{id:"em1", q:"æ€¥é›£è£œåŠ©ç”¨é€”ï¼Ÿ", options:["è²·æ‰‹æ©Ÿ","ç”Ÿæ´»é™·å›°"], a:1}, ...JOB_QS.slice(0,5)] },
      
      // CCSA
      ccsa_aid: { title:"CCSAï¼šç¶“æ¿Ÿæ”¯æŒ", pickOne:false, questions: DORM_QS.slice(0,5) },
      ccsa_accompany: { title:"CCSAï¼šç”³è«‹é™ªåŒ", pickOne:false, questions: DORM_QS.slice(5,10) },
      ccsa_counseling: { title:"CCSAï¼šå¿ƒç†è«®å•†", pickOne:false, questions: DORM_QS.slice(10,15) },
      ccsa_training: { title:"CCSAï¼šè‡ªç«‹åŸ¹è¨“", pickOne:false, questions: JOB_QS.slice(10,15) },
      ccsa_interview: { title:"CCSA å®¿èˆé¢è«‡", pickOne:false, questions: DORM_QS },
      
      // Housing Check
      house_check: { title:"çœ‹æˆ¿æª¢æ ¸", pickOne:false, questions: HOUSE_QS },
      contract_check: { title:"ç°½ç´„æª¢æŸ¥", pickOne:false, questions: HOUSE_QS.slice(10,20) }, 
      rule_check: { title:"åˆç§Ÿå”è­°", pickOne:false, questions: DORM_QS.slice(0,5) },
    };

    /***********************
     * Components
     ***********************/
    function IconWrapper({ children, className }){ return <svg viewBox="0 0 24 24" className={"w-6 h-6 " + (className||"")} fill="none" stroke="currentColor" strokeWidth="2.3" strokeLinecap="round" strokeLinejoin="round">{children}</svg>; }
    function IconHome(){ return <IconWrapper><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/></IconWrapper>; }
    function IconHouse(){ return <IconWrapper><path d="M4 11 12 4l8 7"/><path d="M6 10v10h12V10"/><path d="M10 20v-6h4v6"/></IconWrapper>; }
    function IconBriefcase(){ return <IconWrapper><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M3 13h18"/></IconWrapper>; }
    function IconMap(){ return <IconWrapper><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15"/><path d="M15 6v15"/></IconWrapper>; }
    function IconWallet(){ return <IconWrapper><path d="M20 8V6a2 2 0 0 0-2-2H6a3 3 0 0 0 0 6h12a2 2 0 0 1 2 2v2"/><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M16 14h2"/></IconWrapper>; }
    function IconSpinner({className}){ return <IconWrapper className={className}><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></IconWrapper>; }

    function StatPill({ label, value, colorClass }){
      return (
        <div className="bg-white border-2 border-black rounded-lg px-2 py-1 flex-1 min-w-[70px] shadow-[2px_2px_0_#000]">
          <div className="flex justify-between items-end">
            <div className="font-pixel text-lg leading-none">{label}</div>
            <div className="font-pixel text-xl leading-none">{value}</div>
          </div>
          <div className="mt-1 h-2 w-full bg-slate-200 rounded-full border border-black overflow-hidden">
            <div className={"h-full " + colorClass} style={{width: clamp(value,0,100) + "%"}}></div>
          </div>
        </div>
      );
    }

    function StatBar({ state, livingCost }){
      return (
        <div className="p-3 sticky top-0 z-10">
          <div className="bg-white border-2 border-black rounded-xl p-3 shadow-[4px_4px_0_#000]">
            <div className="flex justify-between items-center">
              <div className="font-pixel text-2xl">W{state.week}/{state.maxWeeks} <span className="text-sm font-sans text-slate-500">(-${livingCost})</span></div>
              <div className="flex gap-1">{[...Array(state.maxAp)].map((_,i) => <div key={i} className={"w-3 h-3 border border-black rounded-full " + (i<state.ap?"bg-yellow-400":"bg-slate-200")}></div>)}</div>
            </div>
            <div className="mt-2 flex gap-2">
              <StatPill label="é«”åŠ›" value={state.health} colorClass="bg-emerald-400" />
              <StatPill label="å¿ƒæƒ…" value={state.mood} colorClass="bg-yellow-400" />
              <StatPill label="è³‡å®‰" value={state.security} colorClass="bg-sky-400" />
            </div>
          </div>
        </div>
      );
    }

    function AppIcon({ label, onClick, color, Icon }){
      return (
        <button onClick={onClick} className={"w-full p-4 flex items-center justify-between border-2 border-black rounded-xl shadow-[4px_4px_0_#000] active:translate-x-1 active:translate-y-1 active:shadow-[2px_2px_0_#000] transition-all " + color}>
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-white border-2 border-black rounded-lg flex items-center justify-center"><Icon/></div>
            <div className="text-left">
              <div className="font-pixel text-2xl leading-none">{label}</div>
              <div className="text-xs text-slate-800 mt-1">é»æ“Šé€²å…¥</div>
            </div>
          </div>
          <div className="font-pixel text-2xl">&rarr;</div>
        </button>
      );
    }

    function ModalWrapper({ title, children, onClose, footer, headerColor="bg-white", headerText="text-black" }){
      return (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
          <div className="w-full max-h-[85%] flex flex-col bg-white border-2 border-black rounded-xl shadow-[6px_6px_0_#000] overflow-hidden animate-[modalPop_0.2s_ease-out]">
            <div className={`p-3 border-b-2 border-black flex justify-between items-center ${headerColor}`}>
              <h2 className={`font-pixel text-2xl ${headerText}`}>{title}</h2>
              <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-white border-2 border-black rounded shadow-[2px_2px_0_#000] active:shadow-none active:translate-y-1">X</button>
            </div>
            <div className="p-4 overflow-y-auto flex-1 text-sm leading-relaxed whitespace-pre-wrap">{children}</div>
            {footer && <div className="p-3 border-t-2 border-black bg-slate-50">{footer}</div>}
          </div>
        </div>
      );
    }

    // Result Radar Chart Component
    function ResultRadar({ stats }) {
      const chartRef = useRef(null);
      useEffect(() => {
        if (chartRef.current) {
          const ctx = chartRef.current.getContext('2d');
          new Chart(ctx, {
            type: 'radar',
            data: {
              labels: ['ç¶“æ¿Ÿèƒ½åŠ›', 'è²¡å‹™ç®¡ç†', 'è‡ªç†ç”Ÿæ´»', 'ä½æ‰€ç©©å®š', 'å°±æ¥­èƒ½åŠ›', 'å­¸ç¿’èƒ½åŠ›', 'é—œä¿‚ç¶²çµ¡', 'å•é¡Œè§£æ±º', 'å¿ƒç†èƒ½é‡'],
              datasets: [{
                label: 'è‡ªç«‹èƒ½åŠ›æŒ‡æ¨™',
                data: [
                  stats.financial_income, stats.financial_manage,
                  stats.living_selfcare, stats.living_housing, stats.living_job, stats.living_learning,
                  stats.social_network, stats.social_problem, stats.social_resilience
                ],
                backgroundColor: 'rgba(59, 130, 246, 0.4)', // Slightly transparent blue
                borderColor: '#1d4ed8', // Darker blue
                borderWidth: 2,
                pointBackgroundColor: '#1d4ed8',
                pointBorderColor: '#fff',
                pointRadius: 4,
                pointHoverRadius: 6
              }]
            },
            options: {
              scales: { 
                r: { 
                  suggestedMin: 0, 
                  suggestedMax: 100, 
                  ticks: { 
                    stepSize: 20, 
                    display: false // Clean look
                  },
                  grid: { color: 'rgba(0, 0, 0, 0.1)' },
                  pointLabels: {
                    font: {
                      family: "'Noto Sans TC', sans-serif",
                      size: 14, // Larger font
                      weight: 'bold'
                    },
                    color: '#333'
                  },
                  angleLines: { color: 'rgba(0, 0, 0, 0.2)' }
                } 
              },
              plugins: { 
                legend: { display: false } 
              },
              maintainAspectRatio: false
            }
          });
        }
      }, []);
      return <div className="relative w-full h-64"><canvas ref={chartRef}></canvas></div>;
    }

    /***********************
     * Main App
     ***********************/
    function App(){
      const screenRef = useRef(null); 
      const [state, setState] = useState(() => ({ ...INITIAL_STATS, bills:[], logs:[], inventory:{}, ledger:[], missions:{}, achievements:{} }));
      const [route, setRoute] = useState("start");
      const [modal, setModal] = useState(null);
      const [floats, setFloats] = useState([]);
      const [spinning, setSpinning] = useState(false); // Wheel state
      
      const currentHouse = useMemo(() => HOUSING.find(h => h.id === state.houseId) || null, [state.houseId]);
      const livingCost = useMemo(() => calcLivingCost(state, currentHouse), [state, currentHouse]);

      const pushLog = (text) => setState(s => ({...s, logs:[{id:uid(), text:`[W${s.week}] ${text}`}, ...s.logs].slice(0,30)}));
      const addFloat = (kind, text) => {
        const id=uid(); setFloats(p=>[...p,{id,kind,text,x:50+Math.random()*200,y:100+Math.random()*100}]);
        setTimeout(()=>setFloats(p=>p.filter(f=>f.id!==id)),900);
      };
      const spendAP = (cost=1) => {
        if(state.ap<cost){ addFloat("bad","APä¸è¶³"); return false; }
        setState(s=>({...s, ap:s.ap-cost})); return true;
      };
      const changeState = (fn, float) => {
        setState(prev => {
          const next = fn(prev);
          if(float) addFloat(float.kind, float.text);
          return next;
        });
      };

      const grantAchievement = (tag) => setState(s => (s.achievements[tag] ? s : { ...s, achievements: { ...s.achievements, [tag]: true } }));
      const grantMission = (key) => setState(s => (s.missions[key] ? s : { ...s, missions: { ...s.missions, [key]: true } }));

      // Events
      const triggerRandomEvent = () => {
        if(Math.random()>0.6) return;
        const pool = Object.values(SCENARIOS);
        const ev = pool[Math.floor(Math.random()*pool.length)];
        setModal({ type:"event", event:ev });
      };

      // Define ALL logic functions FIRST
      const resolveResourceQuiz = (passed, actionKey) => {
        setModal(null);
        if(!passed){
          changeState(s => ({...s, mood: clamp(s.mood-6,0,100)}), {kind:"warn", text:"å¿ƒæƒ… -6"});
          pushLog("æ¸¬é©—æœªé€šéï¼šè«‹å›æƒ³ã€Œè‡ªç«‹ã€çš„é—œéµæ¦‚å¿µã€‚");
          return;
        }

        if(actionKey === "job_test"){
          changeState(s => applyDelta(s, {money:1000, mood:2, ccsa:{living_job:10}}), {kind:"ok", text:"$1000 å¿ƒæƒ…+2"});
          pushLog("è·å ´æ¸¬é©—é€šéï¼šç²å¾—çå‹µé‡‘ 1000 å…ƒã€‚");
          grantAchievement("æ±‚è·åŠ é€Ÿå™¨");
        }
        else if(actionKey === "welfare_life"){
          changeState(s => applyDelta(s, {health:20, ccsa:{living_selfcare:10}}), {kind:"ok", text:"é«”åŠ› +20"});
          pushLog("ç”Ÿæ´»æ”¯æŒç”³è«‹æˆåŠŸï¼šé«”åŠ›æ¢å¾©ã€‚");
          grantAchievement("å–„ç”¨è³‡æº");
        }
        else if(actionKey === "welfare_emergency"){
          changeState(s => applyDelta(s, {money:5000, ccsa:{financial_income:10}}), {kind:"ok", text:"$5000"});
          pushLog("æ€¥é›£è£œåŠ©æ ¸ç™¼ï¼šç²å¾— 5000 å…ƒã€‚");
          grantAchievement("åº¦éé›£é—œ");
        }
        else if(actionKey === "ccsa_aid"){
          changeState(s => applyDelta(s, {money:3000, ccsa:{financial_income:10}}), {kind:"ok", text:"$3000"});
          pushLog("CCSA ç¶“æ¿Ÿæ”¯æŒï¼šç²å¾— 3000 å…ƒã€‚");
          grantAchievement("å¾—åˆ°å¹«åŠ©");
        }
        else if(actionKey === "ccsa_accompany"){
          changeState(s => ({...s, inventory:{...s.inventory, accompaniment_card:true}, ccsaStats:{...s.ccsaStats, social_network:clamp(s.ccsaStats.social_network+15,0,100)}}), {kind:"ok", text:"ç²å¾—é™ªåŒå¡"});
          pushLog("ç”³è«‹æˆåŠŸï¼šç²å¾—ã€Œç¤¾å·¥é™ªåŒå¡ã€ã€‚");
          grantAchievement("æ‡‚å¾—æ±‚åŠ©");
        }
        else if(actionKey === "ccsa_counseling"){
          changeState(s => applyDelta(s, {mood:30, health:10, ccsa:{social_resilience:15}}), {kind:"ok", text:"å¿ƒæƒ…+30 é«”åŠ›+10"});
          pushLog("è«®å•†çµæŸï¼šèº«å¿ƒç‹€æ…‹å¤§å¹…æ¢å¾©ã€‚");
          grantAchievement("æƒ…ç·’ç…§é¡§");
        }
        else if(actionKey === "ccsa_training"){
          changeState(s => {
            const nextMax = clamp(s.maxAp+1,1,9);
            return applyDelta({...s, maxAp:nextMax, ap:clamp(s.ap+1,0,nextMax)}, {ccsa:{living_learning:15}});
          }, {kind:"ok", text:"è¡Œå‹•åŠ›å‡ç´š"});
          pushLog("è‡ªç«‹åŸ¹è¨“å®Œæˆï¼šAP ä¸Šé™ +1ã€‚");
          grantAchievement("æå‡è¡Œå‹•åŠ›");
        }
        grantMission("usedResources");
      };

      const resolveEvent = (eventKey, choiceKey) => {
        setModal(null);
        const ev = SCENARIOS[eventKey];
        if(!ev) return;

        if(eventKey === "friend_loan"){
          if(choiceKey === "safe"){
            const loss = Math.min(500, Math.max(0, Math.floor(state.money*0.12)));
            changeState(s => applyDelta(s, {money:-loss, mood:-1, ccsa:{social_network:5}}), {kind:"warn", text:`å€Ÿå‡º ${loss}`});
            pushLog(`å€Ÿå‡ºå°‘é‡éŒ¢ï¼šæå¤± ${loss}ã€‚`);
            grantAchievement("å–„ç”¨ç•Œç·š");
          }else if(choiceKey === "risky"){
            const loss = Math.min(2000, Math.max(800, Math.floor(state.money*0.35)));
            changeState(s => applyDelta(s, {money:-loss, mood:-8, ccsa:{social_problem:-5}}), {kind:"bad", text:`æå¤± ${loss}`});
            pushLog(`å€Ÿå‡ºå¤§ç­†éŒ¢ï¼šæå¤± ${loss}ã€‚`);
          }else{
            changeState(s => applyDelta(s, {mood:1, ccsa:{social_problem:5}}), {kind:"ok", text:"æ‹’çµ•æˆåŠŸ"});
            pushLog("å©‰æ‹’å€Ÿæ¬¾ã€‚");
            grantAchievement("æ‹’çµ•é«˜æ‰‹");
          }
        }
        else if(eventKey === "scam_job" || eventKey === "scam_romance"){
           if(choiceKey === "safe") {
             changeState(s => applyDelta(s, {security:3, ccsa:{social_problem:10}}), {kind:"ok", text:"è­˜ç ´è©é¨™"});
             pushLog("æˆåŠŸè­˜ç ´è©é¨™ï¼");
             grantAchievement("é˜²è©é›·é”");
           } else if (choiceKey === "very_risky") {
             changeState(s => applyDelta(s, {money:-state.money, mood:-20, security:-20, ccsa:{social_problem:-20}}), {kind:"bad", text:"è³‡ç”¢æ­¸é›¶"});
             pushLog("æ…˜é­è©é¨™ï¼Œå¸³æˆ¶æ­¸é›¶ã€‚");
           } else {
             changeState(s => applyDelta(s, {money:-2000, mood:-10, security:-5}), {kind:"bad", text:"æå¤± 2000"});
             pushLog("é­è©é¨™æå¤±é‡‘éŒ¢ã€‚");
           }
        }
        else if(eventKey === "accident" || eventKey === "sickness"){
           const hasIns = eventKey==="accident" ? state.inventory.accident_insurance : state.inventory.health_insurance;
           if(choiceKey === "handle" || choiceKey === "rest"){
             if(hasIns){
               changeState(s => applyDelta(s, {health:5, mood:2, money:-200}), {kind:"ok", text:"ä¿éšªç†è³ "});
               pushLog("æœ‰ä¿éšªå”åŠ©ï¼Œè² æ“”å¤§å¹…æ¸›è¼•ã€‚");
             } else {
               changeState(s => applyDelta(s, {health:5, money:-1500}), {kind:"warn", text:"é†«ç™‚è²» -1500"});
               pushLog("ç„¡ä¿éšªï¼Œéœ€å…¨é¡è² æ“”é†«ç™‚è²»ã€‚");
             }
           } else {
             changeState(s => applyDelta(s, {health:-20, mood:-10}), {kind:"bad", text:"ç—…æƒ…æƒ¡åŒ–"});
             pushLog("é¸æ“‡ç¡¬æ’ï¼Œå°è‡´èº«é«”ç‹€æ³æƒ¡åŒ–ã€‚");
           }
        }
        else if(eventKey === "police"){
           if(choiceKey === "cooperate"){
             if(state.inventory.good_citizen_card){
               changeState(s => applyDelta(s, {mood:5}), {kind:"ok", text:"è‰¯æ°‘è­‰é€šé"});
               pushLog("å‡ºç¤ºè‰¯æ°‘è­‰ï¼Œå¿«é€Ÿé€šé—œã€‚");
             } else {
               changeState(s => applyDelta(s, {mood:-5}), {kind:"warn", text:"ç›¤æŸ¥è¨±ä¹…"});
               pushLog("é…åˆç›¤æŸ¥ï¼Œä½†èŠ±äº†ä¸å°‘æ™‚é–“ã€‚");
             }
           } else {
             changeState(s => applyDelta(s, {mood:-20, security:-10}), {kind:"bad", text:"è¡çª"});
             pushLog("èˆ‡è­¦æ–¹ç™¼ç”Ÿè¡çªï¼Œè¢«å¸¶å›è­¦å±€ã€‚");
           }
        }
      };

      const resolveJobQuiz = (passed, job) => {
        setModal(null);
        if(passed){
          const income = job.wage * 8;
          changeState(s => applyDelta(s, {money:income, health:-job.energy, mood:job.mood, ccsa:job.ccsa}), {kind:"ok", text:`+${income}`});
          pushLog(`å·¥ä½œå®Œæˆï¼šæ”¶å…¥ ${income}`);
          grantMission("stableWork");
          grantAchievement("ç©©å®šæ‰“å·¥äºº");
        } else {
          changeState(s => applyDelta(s, {mood:-10}), {kind:"bad", text:"é¢è©¦å¤±æ•—"});
          pushLog("é¢è©¦æœªé€šéã€‚");
        }
      };

      const resolveHouseQuiz = (passed, house) => {
        setModal(null);
        if(passed){
          changeState(s => ({...applyDelta(s, {money:-house.deposit, security:house.security, ccsa:house.ccsa}), hasHouse:true, houseName:house.title, houseId:house.id}), {kind:"ok", text:"ç°½ç´„æˆåŠŸ"});
          pushLog(`å…¥ä½ï¼š${house.title}`);
          grantMission("stableHousing");
          grantAchievement(house.isCCSA?"ä½é€²æ”¯æŒç³»çµ±":"æœ‰æ®¼è¸ç‰›");
        } else {
          changeState(s => applyDelta(s, {mood:-6}), {kind:"bad", text:"ç°½ç´„å¤±æ•—"});
          pushLog("çœ‹æˆ¿æª¢æ ¸æœªé€šéã€‚");
        }
      };

      const purchase = (item, method) => {
        if(item.special === "creditCard"){
          if(state.age<18) { addFloat("warn","18+"); return; }
          changeState(s=>({...s, inventory:{...s.inventory, credit_card:true}}), {kind:"ok", text:"ä¿¡ç”¨å¡"});
          setModal(null); return;
        }
        if(item.scam) {
          changeState(s=>applyDelta(s, {money:-item.price, mood:-25, ccsa:{financial_manage:-10}}), {kind:"bad", text:"è©é¨™!"});
          pushLog(`è³¼è²· ${item.name} é­è©é¨™ã€‚`);
          setModal(null); return;
        }
        if(method==="cash"){
          // Safety: spread undefined property is valid in object literal, but ...item.effect||{} is safer
          changeState(s=>applyDelta(s, {money:-item.price, ...(item.effect||{}), ccsa:{financial_manage:5}}), {kind:"ok", text:"è³¼è²·æˆåŠŸ"});
        }
        setModal(null);
      };

      const advanceWeek = () => {
        if(state.week > state.maxWeeks){ setModal({type:"ending"}); return; }
        
        let next = {...state};
        let cost = calcLivingCost(next, currentHouse);
        
        next.bills.forEach(b => { cost += b.amount; b.remainingWeeks--; });
        next.bills = next.bills.filter(b => b.remainingWeeks > 0);
        next.money -= cost;
        next.week++;
        next.ap = next.maxAp;
        next.mood = clamp(next.mood-5,0,100);
        
        if(next.money < 0 && next.hasHouse && !currentHouse?.isCCSA){
          next.hasHouse = false; next.houseId=""; next.mood-=20;
          pushLog("ç©æ¬ æˆ¿ç§Ÿè¢«è¿«æ¬é›¢ï¼");
        }
        
        pushLog(`é€±çµç®—ï¼šæ”¯å‡º ${cost}`);
        setState(next);
        
        if(next.week > next.maxWeeks) setTimeout(()=>setModal({type:"ending"}),500);
        else setTimeout(triggerRandomEvent, 800);
      };

      const spinWheel = () => {
        setSpinning(true);
        setTimeout(() => {
          const pick = CHARACTER_ORIGINS[Math.floor(Math.random()*CHARACTER_ORIGINS.length)];
          const age = 15 + Math.floor(Math.random()*5);
          changeState(s=>({...s, money:pick.money, age, origin:pick}));
          pushLog(`é–‹å±€ï¼š${pick.label}, ${pick.money}å…ƒ, ${age}æ­²`);
          setSpinning(false);
          setRoute("home");
        }, 1500);
      };

      const calcEnding = () => {
        const moneyOk = state.money > 0;
        const taskCount = Object.values(state.missions).filter(Boolean).length;
        const pass = (state.week > state.maxWeeks) && moneyOk && taskCount >= 2;
        let title = "åŠªåŠ›ç”Ÿå­˜çš„æ–°äºº";
        if(state.money < 0) title = "è² å‚µç´¯ç´¯çš„å€–å­˜è€…";
        else if(state.money >= 8000 && state.hasHouse) title = "è‡ªç«‹æ¨¡ç¯„ç”Ÿ";
        
        const c = state.ccsaStats;
        let feedback = "ã€ç¸½çµå›é¥‹ã€‘\n";
        
        // Critical Financial Check: Debt overrides high stats
        if (state.money < 0) {
            feedback += "âš  è²¡å‹™è­¦ç¤ºï¼šé›–ç„¶ä½ å¯èƒ½å…·å‚™ç†è²¡çŸ¥è­˜ï¼Œä½†ç›®å‰è™•æ–¼ã€Œè² å‚µã€ç‹€æ…‹ã€‚é€™æé†’æˆ‘å€‘ï¼šçŸ¥è­˜èˆ‡åŸ·è¡Œä¹‹é–“å­˜åœ¨è½å·®ï¼Œè«‹å‹™å¿…æª¢è¦–é–‹éŠ·æˆ–æ„å¤–é¢¨éšªã€‚\n";
        } else if (c.financial_manage < 60) {
            feedback += "âš  è²¡å‹™ç®¡ç†ï¼šå»ºè­°é¤Šæˆè¨˜å¸³ç¿’æ…£ï¼Œå€åˆ†ã€Œæƒ³è¦ã€èˆ‡ã€Œéœ€è¦ã€ã€‚\n";
        } else {
            feedback += "âœ… è²¡å‹™ç®¡ç†ï¼šä½ çš„é‡‘éŒ¢è§€å¿µå¾ˆæ£’ï¼Œæ‡‚å¾—æœªé›¨ç¶¢ç¹†ï¼\n";
        }
        
        if (c.living_housing < 60) feedback += "âš  ä½æ‰€ç©©å®šï¼šç§Ÿå±‹å®‰å…¨çŸ¥è­˜éœ€åŠ å¼·ï¼Œé¿å…é¸æ“‡å±éšªçš„ç’°å¢ƒã€‚\n";
        
        if (c.social_network < 60 && c.social_problem < 60) feedback += "âš  è³‡æºé€£çµï¼šé‡åˆ°å›°é›£æ™‚ç¿’æ…£ç¨è‡ªæ‰¿å—ï¼Œè¨˜å¾—é‚„æœ‰ç¤¾å·¥èˆ‡æ”¿åºœè³‡æºå¯ä»¥å¹«å¿™ã€‚\n";
        else feedback += "âœ… å•é¡Œè§£æ±ºï¼šé‡åˆ°å±æ©Ÿæ™‚æ‡‚å¾—æ±‚åŠ©èˆ‡é‹ç”¨è³‡æºï¼Œé€™æ˜¯è‡ªç«‹æœ€é‡è¦çš„èƒ½åŠ›ï¼\n";

        feedback += "\né€™ä¸€è·¯èµ°ä¾†ä¸å®¹æ˜“ï¼Œè«‹çµ¦è‡ªå·±ä¸€å€‹æŒè²ï¼çœŸå¯¦çš„è‡ªç«‹è·¯ä¸Šï¼ŒCCSA æ°¸é æ”¯æŒä½ ã€‚";

        return { pass, title, feedback };
      };

      // --- Helper for quiz modal content ---
      const QuizContent = ({ title, questions, onPass, onClose }) => {
        const [ans, setAns] = useState({});
        const submit = () => {
          const pass = questions.every(q => ans[q.id] === q.a);
          if(pass) { onPass(); onClose(); }
          else { addFloat("bad","æ¸¬é©—å¤±æ•—"); onClose(); changeState(s=>({...s, mood:s.mood-5})); }
        };
        return (
          <div className="space-y-4">
            {questions.map((q,i) => (
              <div key={q.id} className="bg-slate-50 p-3 rounded border border-gray-300">
                <div className="font-bold mb-2">{i+1}. {q.q}</div>
                {q.options.map((o,idx)=>(
                  <button key={idx} onClick={()=>setAns(p=>({...p, [q.id]:idx}))}
                    className={`block w-full text-left p-2 rounded mb-1 ${ans[q.id]===idx?"bg-black text-white":"bg-white border border-gray-300"}`}>
                    {o}
                  </button>
                ))}
              </div>
            ))}
            <button onClick={submit} className="w-full neo-btn bg-green-400 py-3 font-bold text-xl">é€å‡ºç­”æ¡ˆ</button>
          </div>
        );
      };

      // --- Renderers ---
      const renderStart = () => (
        <div className="p-6 flex flex-col items-center justify-center h-full">
          <div className="font-pixel text-5xl mb-4">è‡ªç«‹å¤§å†’éšª</div>
          <div className="text-center mb-8">8é€±ç”Ÿå­˜æŒ‘æˆ°ï¼šç§Ÿå±‹ã€æ±‚è·ã€é˜²è©é¨™</div>
          
          {/* Wheel Visual */}
          <div className={`wheel-container mb-6 ${spinning ? "animate-spin-fast" : ""}`}>
             <div className="wheel-pointer"></div>
             <div className="wheel-disc"></div>
             <div className="wheel-center"></div>
          </div>

          <button className="neo-btn bg-amber-300 px-6 py-4 font-pixel text-3xl w-full shadow-[4px_4px_0_#000]" 
            onClick={spinWheel} disabled={spinning}>
            {spinning ? "è½‰å‹•ä¸­..." : "å•Ÿå‹•å‘½é‹è½‰ç›¤"}
          </button>
        </div>
      );

      const renderHome = () => (
        <div className="p-4 space-y-4">
          <div className="bg-white border-2 border-black rounded-xl p-4 shadow-[4px_4px_0_#000]">
            <div className="flex justify-between items-end">
              <div>
                <div className="text-sm text-slate-500">ç¾æœ‰è³‡é‡‘</div>
                <div className="font-pixel text-4xl text-emerald-600">${state.money}</div>
              </div>
              <div className="text-right text-sm">
                <div>å¹´é½¡: {state.age}</div>
                <div>{state.hasHouse?"ğŸ æœ‰æˆ¿":"â›ºæµæµªä¸­"}</div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <AppIcon label="å¥½å±‹ç§Ÿæˆ¿" color="bg-orange-100" Icon={IconHouse} onClick={()=>setRoute("app_house")} />
            <AppIcon label="äººåŠ›éŠ€è¡Œ" color="bg-blue-100" Icon={IconBriefcase} onClick={()=>setRoute("app_job")} />
            <AppIcon label="è³‡æºåœ°åœ–" color="bg-emerald-100" Icon={IconMap} onClick={()=>setRoute("app_resource")} />
            <AppIcon label="è²¡å‹™ç®¡å®¶" color="bg-violet-100" Icon={IconWallet} onClick={()=>setModal({type:"shop"})} />
          </div>

          <button onClick={advanceWeek} className="w-full py-4 bg-slate-800 text-white border-2 border-black rounded-xl font-pixel text-2xl shadow-[4px_4px_0_#000] active:translate-y-1 active:shadow-none">
            {state.ap===0 ? "ä¼‘æ¯ (ä¸‹é€±)" : "çµæŸæœ¬é€±"}
          </button>

          <div className="bg-black text-green-400 p-3 rounded-xl font-mono text-xs h-32 overflow-y-auto border-2 border-gray-600">
            {state.logs.map(l=><div key={l.id}>{l.text}</div>)}
          </div>
        </div>
      );

      const renderHouseApp = () => (
        <div className="h-full flex flex-col bg-gray-100">
          <div className="style-591-header p-4 shadow-md flex items-center gap-3 border-b border-orange-600 sticky top-0 z-20">
            <button onClick={()=>setRoute("home")} className="bg-white text-orange-500 px-3 py-1 rounded font-bold">â† è¿”å›</button>
            <h2 className="font-bold text-xl text-white tracking-wide">å¥½å±‹ç§Ÿæˆ¿ç¶²</h2>
          </div>
          <div className="p-3 space-y-3 overflow-y-auto flex-1">
            <div className="bg-orange-50 p-2 text-xs text-orange-700 border border-orange-200 rounded">
              ğŸ’¡ æç¤ºï¼šé ç´„çœ‹æˆ¿éœ€æ¶ˆè€— 1 APï¼Œä¸¦é€šéå®‰å…¨æª¢æ ¸æ¸¬é©—ã€‚
            </div>
            {HOUSING.map(h => (
              <div key={h.id} className="bg-white p-3 border border-gray-300 rounded shadow-sm flex flex-col gap-2">
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className="text-lg font-bold text-gray-800">{h.title}</h3>
                    <div className="text-xs text-gray-500 mt-1">{h.desc}</div>
                  </div>
                  <div className="font-bold text-xl text-591 text-[#ff8000]">${h.rent}<span className="text-xs text-gray-500">/æœˆ</span></div>
                </div>
                <div className="flex gap-2 text-xs">
                  <span className="bg-gray-100 px-2 py-1 rounded text-gray-600">æŠ¼é‡‘ ${h.deposit}</span>
                  <span className={"px-2 py-1 rounded " + (h.security>0 ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700")}>
                    è³‡å®‰ {h.security>0?"+":""}{h.security}
                  </span>
                  {h.isCCSA && <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">ç¤¾ç¦è³‡æº</span>}
                </div>
                <button 
                  disabled={state.hasHouse}
                  onClick={() => {
                    if(!spendAP(1)) return;
                    if(state.age<18 && !state.inventory.accompaniment_card && !h.isCCSA) { pushLog("éœ€ç¤¾å·¥é™ªåŒ"); addFloat("warn","æœªæˆå¹´é™åˆ¶"); return; }
                    const q = QUIZ_DB[h.quizKey];
                    const qs = shuffleArray(q.questions).slice(0,3);
                    setModal({ type:"quiz", title:`çœ‹æˆ¿æª¢æ ¸ï¼š${h.title}`, questions:qs, onPass:()=>resolveHouseQuiz(true, h) });
                  }}
                  className={"w-full py-2 rounded font-bold text-white " + (state.hasHouse ? "bg-gray-400" : "bg-[#ff8000] active:bg-orange-600")}
                >
                  {state.hasHouse ? "å·²å…¥ä½" : "é ç´„çœ‹æˆ¿ (1 AP)"}
                </button>
              </div>
            ))}
          </div>
        </div>
      );

      const renderJobApp = () => (
        <div className="h-full flex flex-col bg-white">
          <div className="style-job-header p-4 shadow-md flex items-center gap-3 sticky top-0 z-20">
            <button onClick={()=>setRoute("home")} className="bg-white text-[#0066cc] px-3 py-1 rounded font-bold">â† è¿”å›</button>
            <h2 className="font-bold text-xl text-white">å°ç£å°±æ¥­é€š</h2>
          </div>
          <div className="p-4 space-y-4 overflow-y-auto flex-1">
            <div className="bg-blue-50 p-3 rounded text-sm text-blue-800 border border-blue-200">
              å‹å‹•éƒ¨æé†’ï¼šæ±‚è·é˜²é¨™ 7 ä¸åŸå‰‡ã€‚ä¸ç¹³éŒ¢ã€ä¸è³¼è²·ã€ä¸è¾¦å¡ã€ä¸ç°½ç´„ã€ä¸é›¢èº«ã€ä¸é£²ç”¨ã€ä¸éæ³•å·¥ä½œã€‚
            </div>
            {JOBS.map(job => {
              const ageOK = state.age >= job.minAge;
              return (
                <div key={job.id} className="border-b border-gray-200 pb-4">
                  <div className="flex justify-between items-start mb-2">
                    <h3 className="text-lg font-bold text-[#0066cc]">{job.title}</h3>
                    <span className="text-red-600 font-bold">${job.wage}/æ™‚</span>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">{job.desc}</p>
                  <div className="flex gap-2 text-xs mb-3">
                    <span className="bg-gray-100 px-2 py-1 rounded">é«”åŠ› -{job.energy}</span>
                    <span className="bg-gray-100 px-2 py-1 rounded">AP -{job.apCost}</span>
                    {!ageOK && <span className="bg-red-100 text-red-600 px-2 py-1 rounded">éœ€å¹´æ»¿ {job.minAge}</span>}
                  </div>
                  <button 
                    onClick={() => {
                      if(!spendAP(job.apCost)) return;
                      if(!ageOK && !state.inventory.accompaniment_card) { addFloat("warn","å¹´é½¡ä¸ç¬¦"); return; }
                      // Fix: Provide default empty array to avoid spread error if interviews is missing
                      const interviews = job.interviews || [];
                      const qs = shuffleArray([...interviews, ...GENERIC_JOB_QUESTIONS]).slice(0,3);
                      setModal({ type:"quiz", title:`é¢è©¦ï¼š${job.title}`, questions:qs, onPass:()=>resolveJobQuiz(true, job) });
                    }}
                    className="border border-[#0066cc] text-[#0066cc] hover:bg-[#0066cc] hover:text-white transition w-full py-2 rounded"
                  >
                    æˆ‘è¦æ‡‰å¾µ
                  </button>
                </div>
              );
            })}
          </div>
        </div>
      );

      const renderResourceApp = () => (
        <div className="p-4 space-y-3 bg-emerald-50 h-full overflow-y-auto">
          <div className="flex justify-between items-center mb-2">
            <h2 className="font-pixel text-3xl">è³‡æºåœ°åœ–</h2>
            <button onClick={()=>setRoute("home")} className="neo-btn bg-white px-3 py-1">è¿”å›</button>
          </div>
          {[
            {id:"job_test", title:"å°±æ¥­æœå‹™ç«™", desc:"è·å ´æ¸¬é©— +$1000", bg:"bg-sky-200"},
            {id:"welfare_life", title:"ç¤¾ç¦ä¸­å¿ƒ-ç”Ÿæ´»", desc:"ç”Ÿæ´»æ”¯æŒ (é«”åŠ›+20)", bg:"bg-amber-200"},
            {id:"welfare_emergency", title:"ç¤¾ç¦ä¸­å¿ƒ-æ€¥é›£", desc:"æ€¥é›£è£œåŠ© (å­˜æ¬¾<2000)", bg:"bg-amber-300"},
            {id:"ccsa_aid", title:"CCSA ç¶“æ¿Ÿæ”¯æŒ", desc:"ç¶“æ¿Ÿæ”¯æŒ +$3000", bg:"bg-emerald-200"},
            {id:"ccsa_accompany", title:"CCSA ç”³è«‹é™ªåŒ", desc:"ç²å¾—é™ªåŒå¡ (æœªæˆå¹´å¿…å‚™)", bg:"bg-emerald-300"},
            {id:"ccsa_counseling", title:"CCSA è«®å•†", desc:"å¿ƒæƒ…+30 é«”åŠ›+10", bg:"bg-emerald-100"},
            {id:"ccsa_training", title:"CCSA è‡ªç«‹åŸ¹è¨“", desc:"è¡Œå‹•åŠ›å‡ç´š (maxAp+1)", bg:"bg-emerald-400"},
            {id:"good_citizen", title:"è­¦å¯Ÿå±€", desc:"ç”³è«‹è‰¯æ°‘è­‰ (18+)", bg:"bg-slate-200"}
          ].map(r => (
            <button key={r.id} className={`w-full p-4 text-left border-2 border-black rounded-xl shadow-[4px_4px_0_#000] ${r.bg}`}
              onClick={()=>{
                if(r.id==="good_citizen" && state.age<18) { addFloat("warn","éœ€ 18+"); return; }
                if(r.id==="good_citizen" && state.inventory.good_citizen_card) { addFloat("warn","å·²æŒæœ‰"); return; }
                
                if(r.id==="welfare_emergency" && state.money>=2000) { addFloat("warn","è³‡æ ¼ä¸ç¬¦"); return; }
                
                if(r.id==="good_citizen") {
                   changeState(s=>({...s, inventory:{...s.inventory, good_citizen_card:true}}), {kind:"ok",text:"ç²å¾—è‰¯æ°‘è­‰"});
                   pushLog("ç”³è«‹æˆåŠŸï¼šç²å¾—è‰¯æ°‘è­‰");
                   return;
                }

                const q = QUIZ_DB[r.id];
                if(q) {
                  const qs = shuffleArray(q.questions).slice(0,3);
                  const finalQs = qs.length > 0 ? qs : q.questions;
                  setModal({ 
                    type:"quiz", 
                    title:q.title, 
                    questions:finalQs, 
                    onPass:()=>resolveResourceQuiz(true, r.id) 
                  });
                }
              }}>
              <div className="font-bold text-xl">{r.title}</div>
              <div className="text-sm">{r.desc}</div>
            </button>
          ))}
        </div>
      );

      const renderEnding = () => {
        const end = calcEnding();
        return (
          <div className="p-4 space-y-4 h-full overflow-y-auto bg-white">
            <div className={`p-4 border-2 border-black rounded-xl text-center ${end.pass?"bg-yellow-200":"bg-gray-200"}`}>
              <h1 className="font-pixel text-4xl mb-2">{end.pass?"æ­å–œé€šé—œ":"å†æ¥å†å²"}</h1>
              <div className="text-xl font-bold">{end.title}</div>
              <div className="text-sm mt-1">æœ€çµ‚å­˜æ¬¾: ${state.money}</div>
            </div>
            
            <div className="bg-white p-2 border-2 border-black rounded-xl">
              <ResultRadar stats={state.ccsaStats} />
            </div>

            <div className="bg-blue-50 p-4 border-2 border-blue-200 rounded-xl text-sm whitespace-pre-wrap leading-relaxed">
              {end.feedback}
            </div>

            <button onClick={()=>window.location.reload()} className="w-full neo-btn bg-black text-white py-4 font-pixel text-2xl">
              é‡æ–°æŒ‘æˆ°
            </button>
          </div>
        );
      };

      // --- Main Render Return ---
      if(modal?.type === "ending") return renderEnding();

      return (
        <div className="w-full h-full flex items-center justify-center">
          <div className="phone-shell">
            <div className="side-btn b1"></div><div className="side-btn b2"></div><div className="side-btn r1"></div>
            <div ref={screenRef} className={"screen scanlines relative flex flex-col " + (state.mood<30?"glitch-effect":"")}>
              {route!=="home" && route!=="start" && <StatBar state={state} livingCost={livingCost} />}
              <div className="flex-1 overflow-y-auto content-scroll">
                {route==="start" && renderStart()}
                {route==="home" && renderHome()}
                {route==="app_house" && renderHouseApp()}
                {route==="app_job" && renderJobApp()}
                {route==="app_resource" && renderResourceApp()}
              </div>
              
              <div className="pointer-events-none absolute inset-0 z-50">
                {floats.map(f=><div key={f.id} style={{left:f.x, top:f.y}} className={`absolute font-pixel text-4xl font-bold text-stroke ${f.kind==="ok"?"text-green-400":"text-red-500"}`}>{f.text}</div>)}
              </div>

              {modal && <ModalWrapper title={modal.title||"ç³»çµ±é€šçŸ¥"} onClose={()=>setModal(null)} 
                footer={modal.type==="event" && <div className="space-y-2">{modal.event.options.map(o=><button key={o.key} className="w-full neo-btn bg-white py-2" onClick={()=>{resolveEvent(modal.event.id,o.key);}}>{o.label}</button>)}</div>}>
                {modal.type==="quiz" ? <QuizContent {...modal} onClose={()=>setModal(null)} /> : 
                 modal.type==="shop" ? <div className="grid grid-cols-1 gap-2">{SHOP_ITEMS.map(i=><button key={i.id} onClick={()=>purchase(i,"cash")} className="neo-soft p-2 flex justify-between"><span>{i.name}</span><span>${i.price}</span></button>)}</div> :
                 modal.type==="event" ? modal.event.body : null}
              </ModalWrapper>}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>